FROM python:3.12.3-slim

WORKDIR /app

ENV UV_PROJECT_ENVIRONMENT="/usr/local/"
ENV UV_COMPILE_BYTECODE=1

# Build-time argument with default false
ARG MCP_ENABLED=false
# Runtime environment variable that can be overridden
ENV MCP_ENABLED=${MCP_ENABLED}

# Install Node.js and MCP dependencies if enabled
RUN if [ "$MCP_ENABLED" = "true" ] ; then \
    apt-get update && \
    apt-get install -y curl build-essential && \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get update && \
    apt-get install -y nodejs && \
    corepack enable && \
    npm install -g @modelcontextprotocol/server-filesystem && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* ; \
    fi

# Set default AGENT_HOME only if MCP is enabled and AGENT_HOME not provided
RUN if [ "$MCP_ENABLED" = "true" ] ; then \
    AGENT_HOME=${AGENT_HOME:-/app/agent_home} && \
    mkdir -p $AGENT_HOME && \
    chown -R nobody:nogroup $AGENT_HOME ; \
    fi

# Ensure paths are set
ENV PATH="/usr/local/bin:/usr/bin:${PATH}"
ENV NODE_PATH=/usr/local/lib/node_modules
ENV AGENT_HOME=${AGENT_HOME:-/app/agent_home}

COPY pyproject.toml .
COPY uv.lock .
RUN pip install --no-cache-dir uv
RUN uv sync --frozen --no-install-project --no-dev

COPY src/agents/ ./agents/
COPY src/core/ ./core/
COPY src/schema/ ./schema/
COPY src/service/ ./service/
COPY src/run_service.py .

CMD ["python", "run_service.py"]