<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">AG-UI æ™ºèƒ½åŠ©æ‰‹</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next@22.4.15/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-i18next@12.2.2/react-i18next.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@7.0.2/i18nextBrowserLanguageDetector.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
    <script src="https://unpkg.com/markdown-it-highlightjs@4.0.1/dist/markdown-it-highlightjs.min.js"></script>
    <script src="https://unpkg.com/markdown-it-task-lists@2.1.1/dist/markdown-it-task-lists.min.js"></script>
    <script src="https://unpkg.com/markdown-it-emoji@2.0.2/dist/markdown-it-emoji.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            margin: 0;
        }

        .chat-container {
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .message-user {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            margin-left: auto;
            max-width: 80%;
            position: relative;
        }

        .message-ai {
            background: linear-gradient(135deg, #6f7a93 0%, #26477b 100%);
            color: white;
            margin-right: auto;
            max-width: 80%;
            position: relative;
        }

        .message-system {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            margin: 0 auto;
            max-width: 90%;
            text-align: center;
        }

        .message-error {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white;
            margin: 0 auto;
            max-width: 90%;
        }

        /* Markdown æ ·å¼ */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            margin: 1em 0 0.5em 0;
            font-weight: 600;
        }

        .markdown-content h1 {
            font-size: 1.5em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
        }

        .markdown-content h3 {
            font-size: 1.1em;
        }

        .markdown-content p {
            margin: 0.5em 0;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin: 0.5em 0;
            padding-left: 1.5em;
        }

        .markdown-content li {
            margin: 0.25em 0;
        }

        .markdown-content blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            margin: 1em 0;
            padding-left: 1em;
            font-style: italic;
            opacity: 0.9;
        }

        .markdown-content code {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: rgba(0, 0, 0, 0.8) !important;
            border-radius: 8px;
            padding: 1.2em;
            margin: 1em 0;
            overflow-x: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .markdown-content pre code {
            background: none !important;
            padding: 0;
            border-radius: 0;
            color: inherit;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        /* Highlight.js æ ·å¼è¦†ç›– */
        .markdown-content .hljs {
            background: rgba(0, 0, 0, 0.8) !important;
            color: #f8f8f2 !important;
            padding: 0;
        }

        .markdown-content .hljs-keyword,
        .markdown-content .hljs-selector-tag,
        .markdown-content .hljs-literal,
        .markdown-content .hljs-section,
        .markdown-content .hljs-link {
            color: #66d9ef !important;
        }

        .markdown-content .hljs-string,
        .markdown-content .hljs-title,
        .markdown-content .hljs-name,
        .markdown-content .hljs-type,
        .markdown-content .hljs-attribute,
        .markdown-content .hljs-symbol,
        .markdown-content .hljs-bullet,
        .markdown-content .hljs-addition,
        .markdown-content .hljs-variable,
        .markdown-content .hljs-template-tag,
        .markdown-content .hljs-template-variable {
            color: #a6e22e !important;
        }

        .markdown-content .hljs-comment,
        .markdown-content .hljs-quote,
        .markdown-content .hljs-deletion,
        .markdown-content .hljs-meta {
            color: #75715e !important;
        }

        .markdown-content .hljs-number,
        .markdown-content .hljs-regexp,
        .markdown-content .hljs-literal {
            color: #ae81ff !important;
        }

        .markdown-content .hljs-built_in,
        .markdown-content .hljs-builtin-name,
        .markdown-content .hljs-class .hljs-title {
            color: #f92672 !important;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1em 0;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.5em;
            text-align: left;
        }

        .markdown-content th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        .markdown-content a {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: white;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .typing-indicator {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .send-button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.4);
        }

        .input-field {
            transition: all 0.3s ease;
        }

        .input-field:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .ag-ui-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
        }

        .status-running {
            background: #f59e0b;
            color: white;
        }

        .status-finished {
            background: #059669;
            color: white;
        }

        .status-error {
            background: #dc2626;
            color: white;
        }

        .status-idle {
            background: #6b7280;
            color: white;
        }

        .event-log {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.75rem;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 0.5rem;
            padding: 0.5rem;
            overflow-y: auto;
        }

        .message-metadata {
            font-size: 0.7rem;
            opacity: 0.7;
            margin-top: 0.25rem;
        }

        .scroll-to-bottom {
            position: fixed;
            bottom: 120px;
            right: 30px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .scroll-to-bottom:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, #3730a3 0%, #6b21a8 100%);
        }

        /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
        .markdown-content .task-list-item {
            list-style: none;
            margin: 0.25em 0;
        }

        .markdown-content .task-list-item-checkbox {
            margin-right: 0.5em;
            transform: scale(1.2);
        }

        .markdown-content .task-list-item-checkbox:checked+* {
            text-decoration: line-through;
            opacity: 0.7;
        }

        /* è‡ªå®šä¹‰å®¹å™¨æ ·å¼ */
        .markdown-content .markdown-tip,
        .markdown-content .markdown-warning,
        .markdown-content .markdown-danger,
        .markdown-content .markdown-info {
            margin: 1em 0;
            padding: 1em;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .markdown-content .markdown-tip {
            background: rgba(5, 150, 105, 0.1);
            border-left-color: #059669;
        }

        .markdown-content .markdown-warning {
            background: rgba(245, 158, 11, 0.1);
            border-left-color: #f59e0b;
        }

        .markdown-content .markdown-danger {
            background: rgba(220, 38, 38, 0.1);
            border-left-color: #dc2626;
        }

        .markdown-content .markdown-info {
            background: rgba(79, 70, 229, 0.1);
            border-left-color: #4f46e5;
        }

        .markdown-content .container-title {
            font-weight: 600;
            margin-bottom: 0.5em;
            font-size: 0.9em;
        }

        /* KaTeXæ•°å­¦å…¬å¼æ ·å¼ */
        .markdown-content .katex {
            font-size: 1.1em;
        }

        .markdown-content .katex-display {
            margin: 1em 0;
            text-align: center;
        }

        .markdown-content .katex-display>.katex {
            display: inline-block;
            white-space: nowrap;
        }

        .markdown-content .katex-block {
            margin: 1em 0;
            text-align: center;
        }

        .markdown-content .katex-error {
            color: #cc0000;
            background: rgba(204, 0, 0, 0.1);
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        // é…ç½® i18next
        const initI18n = () => {
            // ç¿»è¯‘èµ„æº
            const resources = {
                zh: {
                    translation: {
                        title: "AG-UI æ™ºèƒ½åŠ©æ‰‹",
                        subtitle: "åŸºäºAG-UIåè®®çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ",
                        startChat: "å¼€å§‹AG-UIå¯¹è¯",
                        startChatDesc: "ä½“éªŒåŸºäºAG-UIåè®®çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ",
                        features: {
                            streaming: "æ”¯æŒæµå¼å“åº”",
                            tracking: "å®Œæ•´äº‹ä»¶è¿½è¸ª",
                            monitoring: "å®æ—¶çŠ¶æ€ç›‘æ§",
                            markdown: "Markdownæ ¼å¼æ¸²æŸ“"
                        },
                        status: {
                            idle: "ç©ºé—²",
                            starting: "å¯åŠ¨ä¸­",
                            running: "è¿è¡Œä¸­",
                            finished: "å·²å®Œæˆ",
                            error: "é”™è¯¯",
                            connected: "å·²è¿æ¥",
                            connecting: "è¿æ¥ä¸­",
                            disconnected: "æœªè¿æ¥"
                        },
                        buttons: {
                            showEvents: "æ˜¾ç¤ºäº‹ä»¶",
                            hideEvents: "éšè—äº‹ä»¶",
                            clear: "æ¸…ç©º",
                            reset: "é‡ç½®",
                            scrollToBottom: "æ»šåŠ¨åˆ°åº•éƒ¨",
                            switchLanguage: "åˆ‡æ¢è¯­è¨€"
                        },
                        shortcuts: {
                            enter: "å›è½¦é”®å‘é€",
                            languageToggle: "Ctrl+Shift+L åˆ‡æ¢è¯­è¨€"
                        },
                        form: {
                            selectModel: "ğŸ¤– é€‰æ‹©å¤§æ¨¡å‹",
                            defaultModel: "é»˜è®¤",
                            placeholder: "è¾“å…¥æ‚¨çš„é—®é¢˜...",
                            generating: "æ­£åœ¨ç”Ÿæˆå“åº”...",
                            streaming: "æµå¼ä¼ è¾“ä¸­...",
                            mathFormula: "æ•°å­¦å…¬å¼æ­£åœ¨è¾“å…¥ä¸­..."
                        },
                        eventLog: {
                            title: "AG-UI äº‹ä»¶æ—¥å¿—",
                            subtitle: "å®æ—¶äº‹ä»¶æµç›‘æ§",
                            noEvents: "æš‚æ— äº‹ä»¶"
                        },
                        stats: {
                            messages: "æ¡æ¶ˆæ¯",
                            events: "ä¸ªäº‹ä»¶",
                            moreThan: "å¤§äº",
                            model: "æ¨¡å‹"
                        },
                        errors: {
                            connection: "è¿æ¥é”™è¯¯",
                            request: "è¯·æ±‚é”™è¯¯",
                            fetchModels: "è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥"
                        },
                        loading: "æ­£åœ¨åŠ è½½..."
                    }
                },
                en: {
                    translation: {
                        title: "AG-UI Smart Assistant",
                        subtitle: "Smart dialog system based on AG-UI protocol",
                        startChat: "Start AG-UI Chat",
                        startChatDesc: "Experience smart dialog system based on AG-UI protocol",
                        features: {
                            streaming: "âœ¨ Streaming response support",
                            tracking: "ğŸ”„ Complete event tracking",
                            monitoring: "ğŸ“Š Real-time status monitoring",
                            markdown: "ğŸ“ Markdown format rendering"
                        },
                        status: {
                            idle: "Idle",
                            starting: "Starting",
                            running: "Running",
                            finished: "Finished",
                            error: "Error",
                            connected: "Connected",
                            connecting: "Connecting",
                            disconnected: "Disconnected"
                        },
                        buttons: {
                            showEvents: "Show Events",
                            hideEvents: "Hide Events",
                            clear: "Clear",
                            reset: "Reset",
                            scrollToBottom: "Scroll to Bottom",
                            switchLanguage: "Switch Language"
                        },
                        shortcuts: {
                            enter: "Press Enter to send",
                            languageToggle: "Ctrl+Shift+L to toggle language"
                        },
                        form: {
                            selectModel: "ğŸ¤– Select Model",
                            defaultModel: "Default",
                            placeholder: "Enter your question...",
                            generating: "Generating response...",
                            streaming: "Streaming...",
                            mathFormula: "Math formula is being entered..."
                        },
                        eventLog: {
                            title: "AG-UI Event Log",
                            subtitle: "Real-time event stream monitoring",
                            noEvents: "No events"
                        },
                        stats: {
                            messages: "messages",
                            events: "events",
                            moreThan: "more than",
                            model: "Model"
                        },
                        errors: {
                            connection: "Connection error",
                            request: "Request error",
                            fetchModels: "Failed to fetch model list"
                        },
                        loading: "Loading..."
                    }
                }
            };

            // åˆå§‹åŒ– i18next
            return i18next
                .use(i18nextBrowserLanguageDetector)
                .init({
                    resources,
                    fallbackLng: 'en',
                    debug: false,
                    interpolation: {
                        escapeValue: false // React å·²ç»å¤„ç†äº† XSS
                    },
                    detection: {
                        order: ['localStorage', 'navigator', 'htmlTag'],
                        caches: ['localStorage'],
                        lookupLocalStorage: 'i18nextLng',
                        checkWhitelist: true
                    },
                    whitelist: ['zh', 'en'],
                    nonExplicitWhitelist: true
                });
        };

        function App() {
            // ä½¿ç”¨ react-i18next hooks
            const { t, i18n } = ReactI18next.useTranslation();

            // çŠ¶æ€ç®¡ç†
            const [messages, setMessages] = React.useState([]);
            const [input, setInput] = React.useState("");
            const [isLoading, setIsLoading] = React.useState(false);
            const [threadId, setThreadId] = React.useState(null);
            const [runId, setRunId] = React.useState(null);
            const [runStatus, setRunStatus] = React.useState('idle');
            const [currentMessageId, setCurrentMessageId] = React.useState(null);
            const [eventLog, setEventLog] = React.useState([]);
            const [showEventLog, setShowEventLog] = React.useState(false);
            const [connectionStatus, setConnectionStatus] = React.useState('disconnected');
            const [showScrollButton, setShowScrollButton] = React.useState(false);
            const [availableModels, setAvailableModels] = React.useState([]);
            const [selectedModel, setSelectedModel] = React.useState('gpt-4o-mini');
            const [defaultModel, setDefaultModel] = React.useState('gpt-4o-mini');

            // è¯­è¨€åˆ‡æ¢å‡½æ•°
            const toggleLanguage = () => {
                const newLang = i18n.language === 'zh' ? 'en' : 'zh';
                i18n.changeLanguage(newLang);
            };

            // ç›‘å¬é”®ç›˜å¿«æ·é”®
            React.useEffect(() => {
                const handleKeyDown = (event) => {
                    // Ctrl+Shift+L æˆ– Cmd+Shift+L åˆ‡æ¢è¯­è¨€
                    if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'L') {
                        event.preventDefault();
                        toggleLanguage();
                    }
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => {
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, [toggleLanguage]);

            // Refs
            const messagesEndRef = React.useRef(null);
            const messagesContainerRef = React.useRef(null);

            // åˆå§‹åŒ– markdown-it
            const md = React.useMemo(() => {
                const markdownIt = window.markdownit({
                    html: true,
                    linkify: true,
                    typographer: true
                });

                // æ·»åŠ  highlight.js æ’ä»¶
                if (window.markdownItHighlightjs) {
                    markdownIt.use(window.markdownItHighlightjs);
                    console.log('Highlight.js plugin loaded');
                }

                // æ·»åŠ ä»»åŠ¡åˆ—è¡¨æ’ä»¶
                if (window.markdownitTaskLists) {
                    markdownIt.use(window.markdownitTaskLists, {
                        enabled: true,
                        label: true,
                        labelAfter: true
                    });
                    console.log('Task lists plugin loaded');
                }

                // æ·»åŠ è¡¨æƒ…ç¬¦å·æ’ä»¶
                if (window.markdownitEmoji) {
                    markdownIt.use(window.markdownitEmoji);
                    console.log('Emoji plugin loaded');
                }

                // åˆ›å»º KaTeX æ’ä»¶ï¼ˆåŸºäºæ ‡å‡†markdown-it-katexï¼Œä½†ä¼˜åŒ–æµå¼ä¼ è¾“ï¼‰
                const createKatexPlugin = () => {
                    return function (md, options) {
                        options = options || {};

                        // Test if potential opening or closing delimiter (æ¥è‡ªæ ‡å‡†å®ç°)
                        function isValidDelim(state, pos) {
                            var prevChar, nextChar,
                                max = state.posMax,
                                can_open = true,
                                can_close = true;

                            prevChar = pos > 0 ? state.src.charCodeAt(pos - 1) : -1;
                            nextChar = pos + 1 <= max ? state.src.charCodeAt(pos + 1) : -1;

                            // ä¸ºæµå¼ä¼ è¾“æ”¾å®½ä¸€äº›é™åˆ¶
                            if (prevChar === 0x20/* " " */ || prevChar === 0x09/* \t */ ||
                                (nextChar >= 0x30/* "0" */ && nextChar <= 0x39/* "9" */)) {
                                can_close = false;
                            }
                            if (nextChar === 0x20/* " " */ || nextChar === 0x09/* \t */) {
                                can_open = false;
                            }

                            return {
                                can_open: can_open,
                                can_close: can_close
                            };
                        }

                        // è¡Œå†…æ•°å­¦å…¬å¼è§£æå™¨ï¼ˆåŸºäºæ ‡å‡†å®ç°ï¼‰
                        function mathInline(state, silent) {
                            var start, match, token, res, pos;

                            if (state.src[state.pos] !== "$") { return false; }

                            res = isValidDelim(state, state.pos);
                            if (!res.can_open) {
                                if (!silent) { state.pending += "$"; }
                                state.pos += 1;
                                return true;
                            }

                            // è½¬ä¹‰å­—ç¬¦å¤„ç†ï¼ˆæ¥è‡ªæ ‡å‡†å®ç°ï¼‰
                            start = state.pos + 1;
                            match = start;
                            while ((match = state.src.indexOf("$", match)) !== -1) {
                                pos = match - 1;
                                while (state.src[pos] === "\\") { pos -= 1; }

                                if (((match - pos) % 2) == 1) { break; }
                                match += 1;
                            }

                            if (match === -1) {
                                if (!silent) { state.pending += "$"; }
                                state.pos = start;
                                return true;
                            }

                            if (match - start === 0) {
                                if (!silent) { state.pending += "$$"; }
                                state.pos = start + 1;
                                return true;
                            }

                            res = isValidDelim(state, match);
                            if (!res.can_close) {
                                if (!silent) { state.pending += "$"; }
                                state.pos = start;
                                return true;
                            }

                            if (!silent) {
                                token = state.push('math_inline', 'math', 0);
                                token.markup = "$";
                                token.content = state.src.slice(start, match);
                            }

                            state.pos = match + 1;
                            return true;
                        }

                        // å—çº§æ•°å­¦å…¬å¼è§£æå™¨ï¼ˆåŸºäºæ ‡å‡†å®ç°ï¼‰
                        function mathBlock(state, start, end, silent) {
                            // æ–°å¢ï¼šå¦‚æœåœ¨ä»£ç å—å†…ï¼Œåˆ™ä¸å¤„ç†
                            if (state.parentType === 'fence') {
                                return false;
                            }

                            var firstLine, lastLine, next, lastPos, found = false, token,
                                pos = state.bMarks[start] + state.tShift[start],
                                max = state.eMarks[start];

                            if (pos + 2 > max) { return false; }
                            if (state.src.slice(pos, pos + 2) !== '$$') { return false; }

                            pos += 2;
                            firstLine = state.src.slice(pos, max);

                            if (silent) { return true; }
                            if (firstLine.trim().slice(-2) === '$$') {
                                firstLine = firstLine.trim().slice(0, -2);
                                found = true;
                            }

                            for (next = start; !found;) {
                                next++;
                                if (next >= end) { break; }

                                pos = state.bMarks[next] + state.tShift[next];
                                max = state.eMarks[next];

                                if (pos < max && state.tShift[next] < state.blkIndent) {
                                    break;
                                }

                                if (state.src.slice(pos, max).trim().slice(-2) === '$$') {
                                    lastPos = state.src.slice(0, max).lastIndexOf('$$');
                                    lastLine = state.src.slice(pos, lastPos);
                                    found = true;
                                }
                            }

                            if (!found) { return false; }

                            state.line = next + 1;

                            token = state.push('math_block', 'math', 0);
                            token.block = true;
                            token.content = (firstLine && firstLine.trim() ? firstLine + '\n' : '') +
                                state.getLines(start + 1, next, state.tShift[start], true) +
                                (lastLine && lastLine.trim() ? lastLine : '');
                            token.map = [start, state.line];
                            token.markup = '$$';
                            return true;
                        }

                        function escapeHtml(unsafe) {
                            return unsafe
                                .replace(/&/g, "&amp;")
                                .replace(/</g, "&lt;")
                                .replace(/>/g, "&gt;")
                                .replace(/"/g, "&quot;")
                                .replace(/'/g, "&#039;");
                        }

                        // æ¸²æŸ“å™¨ï¼ˆä½¿ç”¨æ ‡å‡†å®ç°çš„æ ·å¼ï¼‰
                        function renderMathInline(tokens, idx) {
                            var latex = tokens[idx].content;
                            try {
                                return window.katex.renderToString(latex, {
                                    displayMode: false,
                                    throwOnError: false
                                });
                            } catch (error) {
                                console.error('KaTeX inline error:', error);
                                return `<span class='katex-error' title='${escapeHtml(error.toString())}'>${escapeHtml(latex)}</span>`;
                            }
                        }

                        function renderMathBlock(tokens, idx) {
                            var latex = tokens[idx].content;
                            try {
                                return "<p class='katex-block'>" + window.katex.renderToString(latex, {
                                    displayMode: true,
                                    throwOnError: false
                                }) + "</p>\n";
                            } catch (error) {
                                console.error('KaTeX block error:', error);
                                return `<p class='katex-block katex-error' title='${escapeHtml(error.toString())}'>${escapeHtml(latex)}</p>\n`;
                            }
                        }

                        // æ³¨å†Œè§£æå™¨å’Œæ¸²æŸ“å™¨
                        md.inline.ruler.after('escape', 'math_inline', mathInline);
                        md.block.ruler.after('blockquote', 'math_block', mathBlock, {
                            alt: ['paragraph', 'reference', 'blockquote', 'list']
                        });
                        md.renderer.rules.math_inline = renderMathInline;
                        md.renderer.rules.math_block = renderMathBlock;
                    };
                };

                // æ·»åŠ  KaTeX æ’ä»¶
                if (window.katex) {
                    const katexPlugin = createKatexPlugin();
                    markdownIt.use(katexPlugin);
                    console.log('KaTeX plugin loaded');
                }

                // è‡ªå®šä¹‰å®¹å™¨æ¸²æŸ“å™¨
                markdownIt.use(function (md) {
                    // æ·»åŠ æç¤ºæ¡†å®¹å™¨
                    const container = function (name, className, title) {
                        md.block.ruler.before('fence', name, function (state, start, end, silent) {
                            const marker = ':';
                            const len = marker.length;
                            let pos = state.bMarks[start] + state.tShift[start];
                            let max = state.eMarks[start];

                            if (pos + len > max) return false;
                            if (state.src.slice(pos, pos + len) !== marker.repeat(3)) return false;

                            const markup = state.src.slice(pos, pos + len);
                            const params = state.src.slice(pos + len, max).trim();

                            if (!params.startsWith(name)) return false;

                            if (silent) return true;

                            let nextLine = start;
                            let autoClosed = false;

                            while (nextLine < end) {
                                nextLine++;
                                pos = state.bMarks[nextLine] + state.tShift[nextLine];
                                max = state.eMarks[nextLine];

                                if (pos < max && state.tShift[nextLine] < state.blkIndent) break;

                                if (state.src.slice(pos, pos + len) === marker.repeat(3)) {
                                    autoClosed = true;
                                    break;
                                }
                            }

                            const oldParent = state.parentType;
                            const oldLineMax = state.lineMax;
                            state.parentType = 'container';

                            const token_o = state.push(name + '_open', 'div', 1);
                            token_o.markup = markup;
                            token_o.block = true;
                            token_o.info = params;
                            token_o.map = [start, nextLine];

                            state.lineMax = nextLine;
                            state.md.block.tokenize(state, start + 1, nextLine);
                            state.lineMax = oldLineMax;
                            state.parentType = oldParent;

                            const token_c = state.push(name + '_close', 'div', -1);
                            token_c.markup = state.src.slice(pos, pos + len);
                            token_c.block = true;

                            state.line = nextLine + (autoClosed ? 1 : 0);
                            return true;
                        });

                        md.renderer.rules[name + '_open'] = function (tokens, idx) {
                            return `<div class="${className}"><div class="container-title">${title}</div>\n`;
                        };

                        md.renderer.rules[name + '_close'] = function () {
                            return '</div>\n';
                        };
                    };

                    // æ·»åŠ ä¸åŒç±»å‹çš„å®¹å™¨
                    container('tip', 'markdown-tip', 'ğŸ’¡ æç¤º');
                    container('warning', 'markdown-warning', 'âš ï¸ è­¦å‘Š');
                    container('danger', 'markdown-danger', 'ğŸš¨ å±é™©');
                    container('info', 'markdown-info', 'â„¹ï¸ ä¿¡æ¯');
                });

                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log('Markdown-it initialized with plugins');
                console.log('hljs available:', !!window.hljs);
                console.log('markdown-it-highlightjs available:', !!window.markdownItHighlightjs);
                console.log('Task lists plugin available:', !!window.markdownitTaskLists);
                console.log('Emoji plugin available:', !!window.markdownitEmoji);
                console.log('KaTeX available:', !!window.katex);
                console.log('KaTeX version:', window.katex ? window.katex.version || 'unknown' : 'N/A');
                if (window.hljs?.getLanguage) {
                    console.log('JavaScript language available:', !!window.hljs.getLanguage('javascript'));
                    console.log('Python language available:', !!window.hljs.getLanguage('python'));
                }

                return markdownIt;
            }, []);

            // æ¸²æŸ“ Markdown å†…å®¹çš„ç»„ä»¶
            const MarkdownContent = ({ content, isStreaming }) => {
                const { t } = ReactI18next.useTranslation();
                const htmlContent = React.useMemo(() => {
                    if (!content) return '';

                    let processedContent = content;

                    // å¦‚æœæ­£åœ¨æµå¼ä¼ è¾“ï¼Œéœ€è¦å¤„ç†ä¸å®Œæ•´çš„æ•°å­¦å…¬å¼
                    if (isStreaming) {
                        // è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥ç´¢å¼•æ˜¯å¦å¯èƒ½åœ¨ä»£ç å›´æ å—å†…
                        const isLikelyInFencedCodeBlock = (text, symbolStartIndex) => {
                            const textBeforeSymbol = text.slice(0, symbolStartIndex);
                            // è®¡ç®— ``` å‡ºç°çš„æ¬¡æ•°
                            const backtickFences = (textBeforeSymbol.match(/```/g) || []).length;
                            // è®¡ç®— ~~~ å‡ºç°çš„æ¬¡æ•°
                            const tildeFences = (textBeforeSymbol.match(/~~~/g) || []).length;
                            // å¦‚æœå›´æ ç¬¦å·æ€»æ•°ä¸ºå¥‡æ•°ï¼Œåˆ™è®¤ä¸ºåœ¨ä»£ç å—å†…
                            return (backtickFences + tildeFences) % 2 === 1;
                        };

                        const incompleteBlockMathRegex = /\\$\\$[^$]*$/; // ä»¥$$å¼€å§‹ä½†æ²¡æœ‰ç»“æŸçš„å—çº§å…¬å¼
                        const incompleteMathRegex = /\\$[^$]*$/;    // ä»¥$å¼€å§‹ä½†æ²¡æœ‰ç»“æŸçš„è¡Œå†…å…¬å¼
                        let placeholderAdded = false;

                        // å¦‚æœæœ‰ä¸å®Œæ•´çš„å—çº§æ•°å­¦å…¬å¼
                        if (incompleteBlockMathRegex.test(processedContent)) {
                            const lastDoubleDollarIndex = processedContent.lastIndexOf('$$');
                            if (lastDoubleDollarIndex !== -1) {
                                // æ£€æŸ¥è¿™ä¸ª$$æ˜¯å¦åœ¨ä»£ç å—å†…
                                if (!isLikelyInFencedCodeBlock(processedContent, lastDoubleDollarIndex)) {
                                    const segmentAfter = processedContent.slice(lastDoubleDollarIndex + 2);
                                    // ç¡®è®¤æ˜¯çœŸçš„æœªé—­åˆ
                                    if (!segmentAfter.includes('$$')) {
                                        processedContent = processedContent.slice(0, lastDoubleDollarIndex) + `\\n\\n*[${t('form.mathFormula')}]*`;
                                        placeholderAdded = true;
                                    }
                                }
                            }
                        }
                        // å¦‚æœæœ‰ä¸å®Œæ•´çš„è¡Œå†…æ•°å­¦å…¬å¼ (å¹¶ä¸”ä¸æ˜¯å—çº§å…¬å¼çš„ä¸€éƒ¨åˆ†)
                        else if (incompleteMathRegex.test(processedContent)) {
                            const lastDollarIndex = processedContent.lastIndexOf('$');
                            if (lastDollarIndex !== -1) {
                                // ç¡®ä¿è¿™ä¸ª $ ä¸æ˜¯æœªé—­åˆ $$ çš„ç¬¬ä¸€ä¸ª $
                                if (processedContent.charAt(lastDollarIndex - 1) !== '$') {
                                    // æ£€æŸ¥è¿™ä¸ª $ æ˜¯å¦åœ¨ä»£ç å—å†…
                                    if (!isLikelyInFencedCodeBlock(processedContent, lastDollarIndex)) {
                                        const segmentAfter = processedContent.slice(lastDollarIndex + 1);
                                        // ç¡®è®¤æ˜¯çœŸçš„æœªé—­åˆ
                                        if (!segmentAfter.includes('$')) {
                                            processedContent = processedContent.slice(0, lastDollarIndex) + `*[${t('form.mathFormula')}]*`;
                                            placeholderAdded = true;
                                        }
                                    }
                                }
                            }
                        }

                        // æ·»åŠ å…‰æ ‡æŒ‡ç¤ºï¼Œä½†å¦‚æœå·²æ·»åŠ å ä½ç¬¦åˆ™ä¸æ·»åŠ 
                        if (!placeholderAdded && !processedContent.endsWith('\\n')) {
                            processedContent += 'â–Š';
                        }
                    }

                    try {
                        return md.render(processedContent);
                    } catch (error) {
                        console.error('Markdown render error:', error);
                        // å¦‚æœæ¸²æŸ“å¤±è´¥ï¼Œè¿”å›åŸå§‹å†…å®¹
                        return `<p>${processedContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>`;
                    }
                }, [content, isStreaming, md, t]);

                return (
                    <div
                        className="markdown-content"
                        dangerouslySetInnerHTML={{ __html: htmlContent }}
                    />
                );
            };

            // åˆå§‹åŒ– highlight.js
            React.useEffect(() => {
                if (window.hljs) {
                    window.hljs.configure({
                        ignoreUnescapedHTML: true,
                        languages: ['javascript', 'python', 'java', 'cpp', 'html', 'css', 'json', 'xml', 'bash', 'go', 'rust', 'typescript', 'jsx', 'tsx']
                    });
                    console.log('Highlight.js initialized');
                }
            }, []);

            // å·¥å…·å‡½æ•°
            const generateUUID = () => {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            const addEventLog = (event) => {
                const timestamp = new Date().toLocaleTimeString();
                setEventLog(prev => [...prev.slice(-49), { // ä¿æŒæœ€è¿‘50æ¡
                    timestamp,
                    type: event.type,
                    data: event
                }]);
            };

            // è·å–æ¨¡å‹åˆ—è¡¨
            React.useEffect(() => {
                const fetchModels = async () => {
                    try {
                        const response = await fetch('/info', {
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        });
                        if (response.ok) {
                            const data = await response.json();
                            setAvailableModels(data.models);
                            setDefaultModel(data.default_model);
                            setSelectedModel(data.default_model);
                        }
                    } catch (error) {
                        console.error(t('errors.fetchModels'), error);
                    }
                };
                fetchModels();
            }, []);

            // ç›‘å¬æ»šåŠ¨
            React.useEffect(() => {
                const container = messagesContainerRef.current;
                if (!container) return;

                const handleScroll = () => {
                    const { scrollTop, scrollHeight, clientHeight } = container;
                    const isNearBottom = scrollHeight - scrollTop - clientHeight < 100;
                    setShowScrollButton(!isNearBottom);
                };

                container.addEventListener('scroll', handleScroll);
                return () => container.removeEventListener('scroll', handleScroll);
            }, []);

            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // ç›‘å¬è¯­è¨€å˜åŒ–ï¼Œæ›´æ–°é¡µé¢æ ‡é¢˜
            React.useEffect(() => {
                const updatePageTitle = () => {
                    const titleElement = document.getElementById('page-title');
                    if (titleElement) {
                        titleElement.textContent = t('title');
                    }
                };

                updatePageTitle();
                // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶
                i18n.on('languageChanged', updatePageTitle);

                return () => {
                    i18n.off('languageChanged', updatePageTitle);
                };
            }, [t, i18n]);

            // AG-UI äº‹ä»¶å¤„ç†å™¨
            const handleAgUiEvent = (event) => {
                console.log('AG-UI Event:', event);
                addEventLog(event);

                switch (event.type) {
                    case 'RUN_STARTED':
                        setRunStatus('running');
                        setThreadId(event.threadId || event.thread_id);
                        setRunId(event.runId || event.run_id);
                        setConnectionStatus('connected');
                        break;

                    case 'STATE_SNAPSHOT':
                        // å¤„ç†çŠ¶æ€å¿«ç…§
                        console.log('State snapshot:', event.snapshot);
                        break;

                    case 'MESSAGES_SNAPSHOT':
                        // å¤„ç†æ¶ˆæ¯å¿«ç…§
                        console.log('Messages snapshot:', event.messages);
                        break;

                    case 'TEXT_MESSAGE_START':
                        setCurrentMessageId(event.messageId || event.message_id);
                        setMessages(prev => [...prev, {
                            id: event.messageId || event.message_id,
                            type: 'ai',
                            content: '',
                            role: event.role,
                            timestamp: event.timestamp,
                            isStreaming: true
                        }]);
                        break;

                    case 'TEXT_MESSAGE_CONTENT':
                        setMessages(prev => {
                            const newMessages = [...prev];
                            const messageIndex = newMessages.findIndex(msg =>
                                msg.id === (event.messageId || event.message_id)
                            );
                            if (messageIndex !== -1) {
                                newMessages[messageIndex].content += event.delta;
                                newMessages[messageIndex].lastUpdate = Date.now();
                            }
                            return newMessages;
                        });
                        break;

                    case 'TEXT_MESSAGE_CHUNK':
                        // å¤„ç†æµå¼token
                        setMessages(prev => {
                            const newMessages = [...prev];
                            const messageIndex = newMessages.findIndex(msg =>
                                msg.id === (event.messageId || event.message_id)
                            );
                            if (messageIndex !== -1) {
                                newMessages[messageIndex].content += event.delta;
                                newMessages[messageIndex].lastUpdate = Date.now();
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„æ¶ˆæ¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
                                newMessages.push({
                                    id: event.messageId || event.message_id,
                                    type: 'ai',
                                    content: event.delta,
                                    role: 'assistant',
                                    timestamp: Date.now(),
                                    isStreaming: true
                                });
                            }
                            return newMessages;
                        });
                        break;

                    case 'TEXT_MESSAGE_END':
                        setCurrentMessageId(null);
                        setMessages(prev => {
                            const newMessages = [...prev];
                            const messageIndex = newMessages.findIndex(msg =>
                                msg.id === (event.messageId || event.message_id)
                            );
                            if (messageIndex !== -1) {
                                newMessages[messageIndex].isStreaming = false;
                                newMessages[messageIndex].completedAt = event.timestamp;
                            }
                            return newMessages;
                        });
                        break;

                    case 'RUN_FINISHED':
                        setRunStatus('finished');
                        setIsLoading(false);
                        setConnectionStatus('disconnected');
                        break;

                    case 'RUN_ERROR':
                        setRunStatus('error');
                        setIsLoading(false);
                        setConnectionStatus('disconnected');
                        setMessages(prev => [...prev, {
                            id: generateUUID(),
                            type: 'error',
                            content: `${t('status.error')} [${event.code || 'UNKNOWN'}]: ${event.message}`,
                            role: 'system',
                            timestamp: event.timestamp,
                            isError: true
                        }]);
                        break;

                    case 'CUSTOM':
                        // å¤„ç†è‡ªå®šä¹‰äº‹ä»¶
                        console.log('Custom event:', event.name, event.value);
                        break;

                    default:
                        console.log('æœªå¤„ç†çš„AG-UIäº‹ä»¶ç±»å‹:', event.type);
                }
            };

            // å‘é€æ¶ˆæ¯
            const handleSubmit = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                const userMsgId = generateUUID();

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                const newUserMessage = {
                    id: userMsgId,
                    type: 'user',
                    content: userMessage,
                    role: 'user',
                    timestamp: Date.now()
                };

                setMessages(prev => [...prev, newUserMessage]);
                setInput("");
                setIsLoading(true);
                setRunStatus('starting');
                setConnectionStatus('connecting');

                try {
                    // å‡†å¤‡å†å²æ¶ˆæ¯
                    const historyMessages = messages.map(msg => ({
                        id: msg.id,
                        role: msg.role,
                        content: msg.content
                    }));

                    // å‘é€è¯·æ±‚
                    const response = await fetch('/chatbot/stream', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'text/event-stream',
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            stream_protocol: 'agui',
                            thread_id: threadId,
                            user_id: generateUUID(),
                            model: selectedModel,
                            stream_tokens: true
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    setConnectionStatus('connected');
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const eventData = JSON.parse(line.slice(6));
                                    handleAgUiEvent(eventData);
                                } catch (e) {
                                    console.error('è§£æAG-UIäº‹ä»¶é”™è¯¯:', e, line);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('è¯·æ±‚é”™è¯¯:', error);
                    setRunStatus('error');
                    setIsLoading(false);
                    setConnectionStatus('error');
                    setMessages(prev => [...prev, {
                        id: generateUUID(),
                        type: 'error',
                        content: `${t('errors.connection')}: ${error.message}`,
                        role: 'system',
                        timestamp: Date.now(),
                        isError: true
                    }]);
                }
            };

            // æ¸…ç©ºå¯¹è¯
            const clearChat = () => {
                setMessages([]);
                setThreadId(null);
                setRunId(null);
                setRunStatus('idle');
                setCurrentMessageId(null);
                setEventLog([]);
                setConnectionStatus('disconnected');
                setSelectedModel(defaultModel);
                setIsLoading(false);
            };

            // æ ¼å¼åŒ–æ—¶é—´æˆ³
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return '';
                const date = new Date(timestamp);
                return date.toLocaleTimeString();
            };

            // è·å–çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
            const getStatusText = (status) => {
                return t(`status.${status}`) || status;
            };

            return (
                <div className="min-h-screen p-4 flex items-center justify-center">
                    <div className="chat-container w-full max-w-6xl h-[90vh] rounded-2xl overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-slate-800 to-indigo-900 p-6 text-white">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <div className="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                                        <svg className="w-7 h-7" fill="currentColor" viewBox="0 0 20 20">
                                            <path fillRule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clipRule="evenodd" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h1 className="text-xl font-semibold">{t('title')}</h1>
                                        <p className="text-slate-300 text-sm">{t('subtitle')}</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className="ag-ui-badge">AG-UI</span>
                                    <span className={`status-badge status-${connectionStatus}`}>
                                        {connectionStatus === 'connected' ? 'ğŸŸ¢' :
                                            connectionStatus === 'connecting' ? 'ğŸŸ¡' :
                                                connectionStatus === 'error' ? 'ğŸ”´' : 'âšª'}
                                        {t(`status.${connectionStatus}`)}
                                    </span>
                                    <span className={`status-badge status-${runStatus}`}>
                                        {getStatusText(runStatus)}
                                    </span>
                                    {threadId && (
                                        <span className="text-xs text-slate-300 bg-white bg-opacity-10 px-2 py-1 rounded">
                                            Thread: {threadId.slice(0, 8)}...
                                        </span>
                                    )}
                                    <span className="text-xs text-slate-300 bg-white bg-opacity-10 px-2 py-1 rounded">
                                        {t('stats.model')}: {selectedModel}
                                    </span>
                                    <button
                                        onClick={() => setShowEventLog(!showEventLog)}
                                        className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded hover:bg-opacity-30 transition-all"
                                    >
                                        {showEventLog ? t('buttons.hideEvents') : t('buttons.showEvents')}
                                    </button>
                                    <button
                                        onClick={clearChat}
                                        className="text-xs bg-white bg-opacity-20 px-2 py-1 rounded hover:bg-opacity-30 transition-all"
                                    >
                                        {t('buttons.clear')}
                                    </button>
                                    <button
                                        onClick={toggleLanguage}
                                        className="text-xs bg-white bg-opacity-20 px-3 py-1 rounded hover:bg-opacity-30 transition-all transform hover:scale-105 font-medium"
                                        title={`${t('buttons.switchLanguage')} (Ctrl+Shift+L)`}
                                    >
                                        {i18n.language === 'zh' ? 'ğŸ‡ºğŸ‡¸ EN' : 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡'}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 flex overflow-hidden">
                            {/* Messages */}
                            <div className="flex-1 flex flex-col">
                                <div
                                    ref={messagesContainerRef}
                                    className="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50"
                                >
                                    {messages.length === 0 && !isLoading && (
                                        <div className="text-center py-12">
                                            <div className="w-20 h-20 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                                                <svg className="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                    <path fillRule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clipRule="evenodd" />
                                                </svg>
                                            </div>
                                            <h3 className="text-lg font-medium text-gray-700 mb-2">{t('startChat')}</h3>
                                            <p className="text-gray-500">{t('startChatDesc')}</p>
                                            <div className="mt-4 text-sm text-gray-400">
                                                <p>{t('features.streaming')}</p>
                                                <p>{t('features.tracking')}</p>
                                                <p>{t('features.monitoring')}</p>
                                                <p>{t('features.markdown')}</p>
                                            </div>
                                        </div>
                                    )}

                                    {messages.map((msg, index) => (
                                        <div key={msg.id || index} className={`flex fade-in ${msg.type === 'user' ? 'justify-end' :
                                            msg.type === 'error' ? 'justify-center' : 'justify-start'
                                            }`}>
                                            <div className={`px-4 py-3 rounded-2xl shadow-lg ${msg.type === 'user' ? 'message-user' :
                                                msg.type === 'error' ? 'message-error' :
                                                    msg.role === 'system' ? 'message-system' : 'message-ai'
                                                }`}>
                                                <MarkdownContent content={msg.content} isStreaming={msg.isStreaming} />
                                                <div className="message-metadata">
                                                    {msg.id && <span>ID: {msg.id.slice(0, 8)}...</span>}
                                                    {msg.timestamp && <span> â€¢ {formatTimestamp(msg.timestamp)}</span>}
                                                    {msg.isStreaming && <span> â€¢ {t('form.streaming')}</span>}
                                                </div>
                                            </div>
                                        </div>
                                    ))}

                                    {isLoading && currentMessageId && (
                                        <div className="flex justify-start">
                                            <div className="message-ai px-4 py-3 rounded-2xl shadow-lg">
                                                <div className="typing-indicator flex space-x-1">
                                                    <div className="w-2 h-2 bg-white rounded-full"></div>
                                                    <div className="w-2 h-2 bg-white rounded-full"></div>
                                                    <div className="w-2 h-2 bg-white rounded-full"></div>
                                                </div>
                                                <div className="message-metadata">
                                                    {t('form.generating')}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    <div ref={messagesEndRef} />
                                </div>

                                {/* Input */}
                                <div className="p-6 bg-white border-t border-gray-200">
                                    {/* æ¨¡å‹é€‰æ‹©å™¨ */}
                                    <div className="mb-4">
                                        <div className="flex items-center justify-between mb-2">
                                            <label className="text-sm font-medium text-gray-700">
                                                {t('form.selectModel')}
                                            </label>
                                            <div className="flex items-center space-x-2">
                                                <span className="text-xs text-gray-500">
                                                    {t('form.defaultModel')}: {defaultModel}
                                                </span>
                                                {selectedModel !== defaultModel && (
                                                    <button
                                                        onClick={() => setSelectedModel(defaultModel)}
                                                        className="text-xs text-blue-600 hover:text-blue-800 underline"
                                                    >
                                                        {t('buttons.reset')}
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                        <select
                                            value={selectedModel}
                                            onChange={(e) => setSelectedModel(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white text-sm"
                                            disabled={isLoading}
                                        >
                                            {availableModels.map((model) => (
                                                <option key={model} value={model}>
                                                    {model}
                                                    {model === defaultModel && ` (${t('form.defaultModel')})`}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    <div className="flex space-x-4">
                                        <input
                                            type="text"
                                            value={input}
                                            onChange={(e) => setInput(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && !e.shiftKey && handleSubmit()}
                                            className="input-field flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                            placeholder={t('form.placeholder')}
                                            disabled={isLoading}
                                        />
                                        <button
                                            onClick={handleSubmit}
                                            disabled={isLoading || !input.trim()}
                                            className="send-button px-6 py-3 text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed font-medium"
                                        >
                                            {isLoading ? (
                                                <svg className="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                                </svg>
                                            ) : (
                                                <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                                </svg>
                                            )}
                                        </button>
                                    </div>
                                    <div className="mt-2 text-xs text-gray-500 flex justify-between">
                                        <span>AG-UI â€¢ {t('features.streaming').replace('âœ¨ ', '')} â€¢ {t('features.tracking').replace('ğŸ”„ ', '')} â€¢ {t('features.markdown').replace('ğŸ“ ', '')} â€¢ {t('stats.model')}: {selectedModel}</span>
                                        <span>{messages.length} {t('stats.messages')} â€¢ {eventLog.length >= 50 ? `${t('stats.moreThan')} 50 ${t('stats.events')}` : `${eventLog.length} ${t('stats.events')}`}</span>
                                    </div>
                                    <div className="mt-1 text-xs text-gray-400 text-center">
                                        <span>{t('shortcuts.enter')} â€¢ {t('shortcuts.languageToggle')}</span>
                                    </div>
                                </div>
                            </div>

                            {/* Event Log Sidebar */}
                            {showEventLog && (
                                <div className="w-80 bg-gray-100 border-l border-gray-200 flex flex-col">
                                    <div className="p-4 bg-gray-200 border-b">
                                        <h3 className="font-medium text-gray-700">{t('eventLog.title')}</h3>
                                        <p className="text-xs text-gray-500">{t('eventLog.subtitle')}</p>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4">
                                        <div className="event-log">
                                            {eventLog.length === 0 ? (
                                                <p className="text-gray-500 text-center py-4">{t('eventLog.noEvents')}</p>
                                            ) : (
                                                eventLog.map((log, index) => (
                                                    <div key={index} className="mb-2 p-2 bg-white rounded border-l-2 border-blue-400">
                                                        <div className="flex justify-between items-center mb-1">
                                                            <span className="font-mono text-xs font-semibold text-blue-600">
                                                                {log.type}
                                                            </span>
                                                            <span className="text-xs text-gray-500">
                                                                {log.timestamp}
                                                            </span>
                                                        </div>
                                                        <pre className="text-xs text-gray-600 whitespace-pre-wrap">
                                                            {JSON.stringify(log.data, null, 2)}
                                                        </pre>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Scroll to bottom button */}
                    {showScrollButton && (
                        <button
                            onClick={scrollToBottom}
                            className="scroll-to-bottom"
                            title={t('buttons.scrollToBottom')}
                        >
                            â†“
                        </button>
                    )}
                </div>
            );
        }

        // åŒ…è£…Appç»„ä»¶ï¼Œæä¾›å›½é™…åŒ–æ”¯æŒ
        const AppWithI18n = () => {
            const [isReady, setIsReady] = React.useState(false);
            const [loadingText, setLoadingText] = React.useState('Loading...');

            React.useEffect(() => {
                initI18n().then((i18nInstance) => {
                    // è®¾ç½®åŠ è½½æ–‡æœ¬
                    const browserLang = navigator.language || navigator.userLanguage;
                    const lang = browserLang.startsWith('zh') ? 'zh' : 'en';
                    setLoadingText(lang === 'zh' ? 'æ­£åœ¨åŠ è½½...' : 'Loading...');

                    setIsReady(true);
                });
            }, []);

            if (!isReady) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-50 to-indigo-100">
                        <div className="text-center">
                            <div className="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center animate-pulse">
                                <svg className="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fillRule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clipRule="evenodd" />
                                </svg>
                            </div>
                            <p className="text-gray-600 text-sm">{loadingText}</p>
                        </div>
                    </div>
                );
            }

            return (
                <ReactI18next.I18nextProvider i18n={i18next}>
                    <App />
                </ReactI18next.I18nextProvider>
            );
        };

        ReactDOM.render(<AppWithI18n />, document.getElementById("root"));
    </script>
</body>

</html>